generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// === EMPRESA (MULTI-TENANT) ===

enum StatusEmpresa {
  ATIVA
  SUSPENSA
  CANCELADA
}

model Empresa {
  id              String         @id @default(cuid())
  nome            String
  slug            String         @unique
  logoUrl         String?
  telefone        String?
  email           String?
  endereco        String?
  status          StatusEmpresa  @default(ATIVA)
  criadoEm        DateTime       @default(now())
  atualizadoEm    DateTime       @updatedAt

  usuarios              Usuario[]
  clientes              Cliente[]
  veiculos              Veiculo[]
  ordens                OrdemServico[]
  servicos              Servico[]
  fotos                 Foto[]
  checklistsPreenchidos ChecklistPreenchido[]
  historicos            HistoricoStatus[]
  assinaturas           Assinatura[]
}

// === AUTENTICACAO ===

model Usuario {
  id        String   @id @default(cuid())
  nome      String
  email     String
  senha     String
  papel     Papel    @default(ATENDENTE)
  ativo     Boolean  @default(true)
  criadoEm  DateTime @default(now())

  empresaId String
  empresa   Empresa  @relation(fields: [empresaId], references: [id])

  ordens     OrdemServico[]
  checklists ChecklistPreenchido[]
  historicos HistoricoStatus[]
  resetsSenha ResetSenha[]

  @@unique([email, empresaId])
}

enum Papel {
  SUPERADMIN
  ADMIN
  ATENDENTE
}

// === CLIENTES E VEICULOS ===

model Cliente {
  id        String   @id @default(cuid())
  nome      String
  telefone  String
  email     String?
  documento String?
  criadoEm  DateTime @default(now())

  empresaId String
  empresa   Empresa  @relation(fields: [empresaId], references: [id])

  veiculos  Veiculo[]
}

model Fabricante {
  id        String   @id @default(cuid())
  nome      String   @unique
  ativo     Boolean  @default(true)
  criadoEm  DateTime @default(now())

  modelos   Modelo[]
}

model Modelo {
  id           String     @id @default(cuid())
  nome         String
  ativo        Boolean    @default(true)
  criadoEm     DateTime   @default(now())

  fabricanteId String
  fabricante   Fabricante @relation(fields: [fabricanteId], references: [id])

  veiculos     Veiculo[]

  @@unique([fabricanteId, nome])
}

model Veiculo {
  id        String   @id @default(cuid())
  placa     String
  cor       String
  ano       Int?
  criadoEm  DateTime @default(now())

  modeloId  String
  modelo    Modelo   @relation(fields: [modeloId], references: [id])

  clienteId String
  cliente   Cliente  @relation(fields: [clienteId], references: [id])

  empresaId String
  empresa   Empresa  @relation(fields: [empresaId], references: [id])

  ordens    OrdemServico[]
}

// === SERVICOS ===

model Servico {
  id        String      @id @default(cuid())
  nome      String
  tipo      TipoServico
  valor     Decimal     @db.Decimal(10, 2)
  ativo     Boolean     @default(true)
  criadoEm  DateTime    @default(now())

  empresaId String
  empresa   Empresa     @relation(fields: [empresaId], references: [id])

  itens     ItemOrcamento[]
}

enum TipoServico {
  SERVICO
  ADICIONAL
}

// === ORDENS DE SERVICO ===

model OrdemServico {
  id           String    @id @default(cuid())
  token        String    @unique @default(cuid())
  status       StatusOS  @default(AGUARDANDO)
  valorTotal   Decimal   @db.Decimal(10, 2)
  dataAgendada DateTime?
  aprovadoEm   DateTime?
  criadoEm     DateTime  @default(now())
  atualizadoEm DateTime  @updatedAt

  veiculoId    String
  veiculo      Veiculo   @relation(fields: [veiculoId], references: [id])

  usuarioId    String
  usuario      Usuario   @relation(fields: [usuarioId], references: [id])

  empresaId    String
  empresa      Empresa   @relation(fields: [empresaId], references: [id])

  itens        ItemOrcamento[]
  fotos        Foto[]
  checklist    ChecklistPreenchido[]
  historico    HistoricoStatus[]
}

enum StatusOS {
  AGUARDANDO
  APROVADO
  AGENDADO
  EM_ANDAMENTO
  FINALIZADO
}

model HistoricoStatus {
  id         String    @id @default(cuid())
  statusDe   StatusOS?
  statusPara StatusOS
  criadoEm   DateTime  @default(now())

  ordemId    String
  ordem      OrdemServico @relation(fields: [ordemId], references: [id], onDelete: Cascade)

  usuarioId  String?
  usuario    Usuario? @relation(fields: [usuarioId], references: [id])

  empresaId  String
  empresa    Empresa  @relation(fields: [empresaId], references: [id])
}

model ItemOrcamento {
  id        String       @id @default(cuid())
  valor     Decimal      @db.Decimal(10, 2)

  ordemId   String
  ordem     OrdemServico @relation(fields: [ordemId], references: [id], onDelete: Cascade)

  servicoId String
  servico   Servico      @relation(fields: [servicoId], references: [id])
}

model Foto {
  id        String       @id @default(cuid())
  url       String
  tipo      TipoFoto
  criadoEm  DateTime     @default(now())

  ordemId   String
  ordem     OrdemServico @relation(fields: [ordemId], references: [id], onDelete: Cascade)

  empresaId String
  empresa   Empresa      @relation(fields: [empresaId], references: [id])
}

enum TipoFoto {
  ENTRADA
  PROGRESSO
  FINAL
}

// === CHECKLIST ===

model ItemChecklist {
  id        String   @id @default(cuid())
  nome      String
  categoria String
  ordem     Int
  ativo     Boolean  @default(true)
  criadoEm  DateTime @default(now())

  preenchidos ChecklistPreenchido[]
}

model ChecklistPreenchido {
  id         String          @id @default(cuid())
  status     StatusChecklist
  observacao String?
  criadoEm   DateTime        @default(now())

  ordemId    String
  ordem      OrdemServico    @relation(fields: [ordemId], references: [id], onDelete: Cascade)

  itemId     String
  item       ItemChecklist   @relation(fields: [itemId], references: [id])

  usuarioId  String
  usuario    Usuario         @relation(fields: [usuarioId], references: [id])

  empresaId  String
  empresa    Empresa         @relation(fields: [empresaId], references: [id])

  @@unique([ordemId, itemId])
}

enum StatusChecklist {
  OK
  DEFEITO
  NAO_APLICA
}

// === MONETIZACAO ===

enum StatusAssinatura {
  TRIAL
  ATIVA
  VENCIDA
  CANCELADA
}

model Plano {
  id           String      @id @default(cuid())
  nome         String
  slug         String      @unique
  maxUsuarios  Int?
  preco        Decimal     @db.Decimal(10, 2)
  ativo        Boolean     @default(true)
  criadoEm     DateTime    @default(now())
  assinaturas  Assinatura[]
}

model Assinatura {
  id         String             @id @default(cuid())
  dataInicio DateTime           @default(now())
  dataFim    DateTime
  status     StatusAssinatura   @default(TRIAL)
  criadoEm   DateTime           @default(now())
  empresaId  String
  empresa    Empresa            @relation(fields: [empresaId], references: [id])
  planoId    String
  plano      Plano              @relation(fields: [planoId], references: [id])
}

model ResetSenha {
  id         String    @id @default(cuid())
  token      String    @unique @default(cuid())
  expiradoEm DateTime
  usadoEm    DateTime?
  criadoEm   DateTime  @default(now())
  usuarioId  String
  usuario    Usuario   @relation(fields: [usuarioId], references: [id])
}
