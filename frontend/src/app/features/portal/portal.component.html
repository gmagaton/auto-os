<div class="portal-container">
  @if (loading()) {
    <div class="portal-loading">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Carregando dados do orcamento...</p>
    </div>
  } @else if (error()) {
    <div class="portal-content">
      <header class="portal-header">
        <div class="portal-logo">
          <img src="assets/branding/logo-dark.png" alt="AutoOS" class="portal-logo-img" />
        </div>
      </header>

      <div class="portal-error-card">
        <mat-icon>error_outline</mat-icon>
        <h2>Orcamento nao encontrado</h2>
        <p>O link que voce acessou e invalido ou expirou. Por favor, entre em contato com a oficina.</p>
      </div>
    </div>
  } @else if (ordem()) {
    <div class="portal-content">
      <!-- Header compacto -->
      <header class="portal-header">
        <div class="portal-logo">
          <img src="assets/branding/logo-dark.png" alt="AutoOS" class="portal-logo-img" />
        </div>
      </header>

      <!-- Status destacado -->
      <div class="detail-card portal-status-card">
        <div class="portal-status-center">
          <span class="status-badge status-badge-lg" [class]="'status-' + ordem()!.status.toLowerCase().replace('_', '-')">
            {{ getStatusLabel(ordem()!.status) }}
          </span>
          <p class="portal-status-description">{{ getStatusDescription(ordem()!.status) }}</p>
        </div>
      </div>

      <!-- Card de resumo -->
      <div class="detail-card">
        <div class="ordem-resumo">
          <div class="resumo-info">
            <span class="resumo-placa">{{ ordem()!.veiculo.placa }}</span>
            <span class="resumo-detalhe">{{ ordem()!.veiculo.modelo.fabricante.nome }} {{ ordem()!.veiculo.modelo.nome }}</span>
            <span class="resumo-detalhe">{{ ordem()!.veiculo.cliente.nome }}</span>
          </div>
          <div class="resumo-total">
            <span class="total-label">Total</span>
            <span class="total-valor">{{ ordem()!.valorTotal | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</span>
          </div>
        </div>
      </div>

      <!-- Botão de aprovação destacado -->
      @if (ordem()!.status === 'AGUARDANDO') {
        <div class="portal-approve-section">
          <button
            mat-raised-button
            color="primary"
            class="portal-approve-btn"
            (click)="confirmarAprovacao()"
            [disabled]="aprovando()"
          >
            @if (aprovando()) {
              <mat-spinner diameter="20"></mat-spinner>
            } @else {
              <mat-icon>check_circle</mat-icon>
              Aprovar Orcamento
            }
          </button>
        </div>
      }

      <!-- Tabs -->
      <mat-tab-group class="detail-tabs" animationDuration="200ms">
        <!-- Tab Dados -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>info</mat-icon>
            <span class="tab-label-text">Dados</span>
          </ng-template>
          <div class="detail-card">
            <div class="info-section">
              <h3><mat-icon>directions_car</mat-icon> Veiculo</h3>
              <div class="info-list">
                <div class="info-row">
                  <span class="label">Placa</span>
                  <span class="value">{{ ordem()!.veiculo.placa }}</span>
                </div>
                <div class="info-row">
                  <span class="label">Modelo</span>
                  <span class="value">{{ ordem()!.veiculo.modelo.fabricante.nome }} {{ ordem()!.veiculo.modelo.nome }}</span>
                </div>
                <div class="info-row">
                  <span class="label">Cor</span>
                  <span class="value">{{ ordem()!.veiculo.cor }}</span>
                </div>
                @if (ordem()!.veiculo.ano) {
                  <div class="info-row">
                    <span class="label">Ano</span>
                    <span class="value">{{ ordem()!.veiculo.ano }}</span>
                  </div>
                }
              </div>
            </div>

            <div class="info-section">
              <h3><mat-icon>person</mat-icon> Cliente</h3>
              <div class="info-list">
                <div class="info-row">
                  <span class="label">Nome</span>
                  <span class="value">{{ ordem()!.veiculo.cliente.nome }}</span>
                </div>
                <div class="info-row">
                  <span class="label">Telefone</span>
                  <span class="value">{{ formatTelefone(ordem()!.veiculo.cliente.telefone) }}</span>
                </div>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Tab Itens -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>receipt</mat-icon>
            <span class="tab-label-text">Itens</span>
          </ng-template>
          <div class="detail-card">
            <div class="info-section">
              <h3><mat-icon>build</mat-icon> Servicos e Adicionais</h3>
              <div class="info-list">
                @for (item of ordem()!.itens; track item.id) {
                  <div class="info-row">
                    <span class="label">
                      {{ item.servico.nome }}
                      <span class="tipo-badge" [class]="item.servico.tipo === 'SERVICO' ? 'tipo-servico' : 'tipo-adicional'">
                        {{ item.servico.tipo === 'SERVICO' ? 'Serv' : 'Adic' }}
                      </span>
                    </span>
                    <span class="value valor-destaque">{{ item.valor | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</span>
                  </div>
                }
              </div>
            </div>
            <div class="total-card">
              <span>Total</span>
              <strong>{{ ordem()!.valorTotal | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</strong>
            </div>
          </div>
        </mat-tab>

        <!-- Tab Fotos -->
        @if (ordem()!.fotos && ordem()!.fotos.length > 0) {
          <mat-tab>
            <ng-template mat-tab-label>
              <mat-icon>photo_library</mat-icon>
              <span class="tab-label-text">Fotos</span>
              <span class="tab-badge">{{ ordem()!.fotos.length }}</span>
            </ng-template>
            <div class="detail-card">
              <mat-tab-group class="photos-inner-tabs">
                @if (getFotosByTipo('ENTRADA').length > 0) {
                  <mat-tab label="Entrada ({{ getFotosByTipo('ENTRADA').length }})">
                    <div class="photos-grid">
                      @for (foto of getFotosByTipo('ENTRADA'); track foto.id) {
                        <div class="photo-item" (click)="abrirFoto(foto.url)">
                          <img [src]="foto.url" [alt]="'Foto de entrada'" />
                        </div>
                      }
                    </div>
                  </mat-tab>
                }
                @if (getFotosByTipo('PROGRESSO').length > 0) {
                  <mat-tab label="Progresso ({{ getFotosByTipo('PROGRESSO').length }})">
                    <div class="photos-grid">
                      @for (foto of getFotosByTipo('PROGRESSO'); track foto.id) {
                        <div class="photo-item" (click)="abrirFoto(foto.url)">
                          <img [src]="foto.url" [alt]="'Foto de progresso'" />
                        </div>
                      }
                    </div>
                  </mat-tab>
                }
                @if (getFotosByTipo('FINAL').length > 0) {
                  <mat-tab label="Final ({{ getFotosByTipo('FINAL').length }})">
                    <div class="photos-grid">
                      @for (foto of getFotosByTipo('FINAL'); track foto.id) {
                        <div class="photo-item" (click)="abrirFoto(foto.url)">
                          <img [src]="foto.url" [alt]="'Foto final'" />
                        </div>
                      }
                    </div>
                  </mat-tab>
                }
              </mat-tab-group>
            </div>
          </mat-tab>
        }

        <!-- Tab Checklist -->
        @if (checklist().length > 0 && hasPreenchidos()) {
          <mat-tab>
            <ng-template mat-tab-label>
              <mat-icon>checklist</mat-icon>
              <span class="tab-label-text">Check</span>
            </ng-template>
            <div class="detail-card">
              @for (categoria of getChecklistCategorias(); track categoria) {
                <div class="info-section">
                  <h3><mat-icon>checklist</mat-icon> {{ categoria }}</h3>
                  <div class="info-list">
                    @for (item of getChecklistByCategoria(categoria); track item.item.id) {
                      @if (item.preenchido) {
                        <div class="info-row checklist-row" [class]="'check-' + item.preenchido.status.toLowerCase().replace('_', '-')">
                          <span class="label">
                            <mat-icon class="check-icon">{{ getChecklistIcon(item.preenchido.status) }}</mat-icon>
                            {{ item.item.nome }}
                          </span>
                          @if (item.preenchido.observacao) {
                            <span class="value check-obs">{{ item.preenchido.observacao }}</span>
                          }
                        </div>
                      }
                    }
                  </div>
                </div>
              }
            </div>
          </mat-tab>
        }
      </mat-tab-group>

      <!-- Footer -->
      <footer class="portal-footer">
        <p>Obrigado pela preferencia!</p>
        <p>Em caso de duvidas, entre em contato conosco.</p>
      </footer>
    </div>
  }
</div>
